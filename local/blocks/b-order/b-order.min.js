function submitForm(e){BX.closeWait(),e="Y"==e?"Y":"N",BX("confirmorder").value=e,$("#ORDER_FORM").submit()}function ajaxResult(i){var e=BX("ORDER_FORM");try{var t=JSON.parse(i);if(t.error)return $("#js-popup-error").modal("show"),void initActions();t.redirect&&(window.top.location.href=t.redirect)}catch(e){$("#order_form_content").html(i),initActions()}BX.onCustomEvent(e,"onAjaxSuccess")}function SetContact(e){BX("profile_change").value="Y",submitForm()}function initOrderActions(){var e=$("body");$('input[name="DELIVERY_ID"]:checked').val()||$('input[name="DELIVERY_ID"]').first().click(),e.on("keyup blur",".js-delivery-address",function(e){checkCourierAddress()}),e.on("click",".js-pvz-on-map",function(e){e.preventDefault(),$(this).addClass("active"),$(".js-pvz-in-list").removeClass("active");e=$(this).parent().parent();e.find(".delivery-pvz-map").removeClass("hidden"),e.find(".delivery-pvz-list").addClass("hidden")}),e.on("click",".js-pvz-in-list",function(e){e.preventDefault(),$(".delivery-pvz-side .b-page__collapse-top__close").click(),$(this).addClass("active"),$(".js-pvz-on-map").removeClass("active");e=$(this).parent().parent();e.find(".delivery-pvz-list").removeClass("hidden"),e.find(".delivery-pvz-map").addClass("hidden")}),e.on("click",".b-order-basket__main-contacts-text-form-btn",function(e){e.preventDefault();var e=$(this).data("type"),i=$(this).data("id"),t=!1;"pvz"==e&&(t=window.pvz[i]),"shop"==e&&(t=window.shops[i]),$(this).closest(".delivery-pvz-side").hide(),setPickupPlace(e,t)}),e.on("click",".delivery-pvz-list-item",function(e){e.preventDefault();var e=$(this).data("pvz"),i=$(this).data("shop"),t=e?"pvz":"shop",o=!1;"pvz"==t&&(o=window.pvz[e]),setPickupPlace(t,o="shop"==t?window.shops[i]:o)}),initActions()}function initActions(){$(".mask-phone").mask("+7(999)999-99-99");var e=$(".b-order__props-delivery .delivery-block.active").find(".delivery-pvz-map"),e=(0<e.length&&initMap(e.attr("id")),$(".b-city-popup__search-btn").on("click",function(){var e=$(".b-city-popup__search input[name=LOCATION]").val();$("#ORDER_PROP_"+window.orderProps.TARIF_LOCATION).val(e),$("#courierStreet").val("").data("selected",""),submitForm()}),$(".delivery-pvz-side .b-page__collapse-top__close").on("click",function(){$(this).closest(".delivery-pvz-side").hide()}),$(".b-order__props-delivery .delivery-block .delivery-pvz-side-how-text").on("click",function(){orderPopup("Как нас найти",$(this).html().replace(/(Далее|Возле|Транспортом|Пешком|Расположение)/g,"</p><p>$1"))}),$("#deliveryPlaceChange").on("click",function(){$("#ORDER_PROP_"+window.orderProps.STORE_ID).val(""),$("#ORDER_PROP_"+window.orderProps.F_ADDRESS).val(""),$(".delivery-pvz-list-item.active").removeClass("active"),$(this).parent().hide(),$(".delivery-block.active").show()}),getDeliveryType());if(("courier"==e||"day"==e?checkCourierAddress:checkSelectedStore)(),$("#fast_delivery").length&&$("#fast_delivery").on("change",function(){submitForm()}),$(".delivery-courier-fast .question").off("click"),$(".delivery-courier-fast .question").on("click",function(){$(this).toggleClass("minus"),$(this).parent().find(".delivery-courier-fast-description").toggleClass("hidden")}),$(".delivery-courier-fast label").off("click"),$(".delivery-courier-fast label").on("click",function(){$("#fast_delivery").click()}),checkOmni(),initStreetAutocomplete(),initOnlinePayDiscountCheckbox(),showOnlinePayDiscountInfo(),showGifts(window.gifts),window.dubbleReload||(window.dubbleReload=!1),console.log("window.needReload="+window.needReload),console.log("window.dubbleReload="+window.dubbleReload),"Y"==window.needReload&&!window.dubbleReload)return window.dubbleReload=!0,window.needReload="N",submitForm(),!1;window.dubbleReload&&(window.dubbleReload=!1),$("#payOnlineHelp").tooltip({html:!0,title:$("#payOnlineHelpText").html(),placement:"right",template:'<div class="tooltip tooltip-online" role="tooltip"><div class="arrow"></div><div class="tooltip-inner"></div></div>',trigger:"click"})}function showGifts(e){var i=$("#js-popup-gifts"),t=i.find(".gift-list");if(t.html(""),i.find(".js-popup-close").click(),!e)return!1;var o,a=!1;for(o in e){var n=e[o],a=!0;t.append('    <div class="gift-one" data-id="'+n.ID+'" data-quantity='+n.QUANTITY+" data-rule="+n.RULE_ID+'>      <div class="gift-image">        <img src="'+n.PHOTO+'" alt="'+n.NAME+'">      </div>      <div class="gift-data">        <div class="gift-name">'+n.NAME+'</div>        <div class="gift-article">'+n.ARTICLE+'</div>        <div class="gift-size">Размер: '+n.SIZE+'</div>        <div class="gift-color">Цвет: '+n.COLOR+'</div>        <div class="gift-price">'+n.PRICE+'</div>        <a class="btn btn-primary" href="#">Выбрать</a>      </div>    </div>    ')}return t.find("a").on("click",function(){return i.modal("hide"),BX.showWait(),$.post("/local/ajax/update_small_cart.php",{action:"ADD2BASKETGIFT",id:$(this).closest(".gift-one").data("id"),quantity:$(this).closest(".gift-one").data("quantity"),rule:$(this).closest(".gift-one").data("rule")},function(e){submitForm("N")}).fail(function(e){BX.closeWait()}),!1}),a&&i.modal("show"),!0}function initStreetAutocomplete(){ymaps.ready(function(){new ymaps.SuggestView("courierStreet",{provider:{suggest:function(e,i){return ymaps.suggest($(".b-header__top-location-city").text()+", "+e)}}}).events.add("select",function(e){checkCourierAddress()})})}function checkCourierAddress(){var e=$("#ORDER_PROP_"+window.orderProps.F_ADDRESS),i=$(".js-cart-address"),o=[];$(".js-delivery-address").each(function(e,i){var t=$(this).val();0<t.length&&o.push($(this).data("text")+t)}),o=o.join(", "),e.val(o),i.html(o)}function orderPopup(e,i){var t=$("#quickViewProduct"),e='<h4 class="modal-title text-center">'+e+"</h4>";e+='<p class="text-center" style="margin-top: 10px;">'+i+"</p>",t.find(".modal-content").html(e),t.modal("show")}function getDeliveryType(){var e,i=$('input[type="radio"][name="DELIVERY_ID"]:checked').val();for(e in window.deliveryId)if(window.deliveryId[e]==i)return e;return!1}function getPaymentType(){var e,i=$('input[type="radio"][name="PAY_SYSTEM_ID"]:checked').val();for(e in window.paySystemId)if(window.paySystemId[e]==i)return e;return!1}function checkOmni(){var e=getDeliveryType(),n=!1;if("courier"!=e&&"day"!=e||(n=window.omni.DELIVERY,$("#fast_delivery").prop("checked")||"day"==e?n=window.omni.FAST_DELIVERY:n.length||(n=window.omni.OMNI_DELIVERY)),"ozon"==e&&(n=window.omni.PICK_POINT),"pickup"==e){n=window.omni.PICKUP;e=$("#ORDER_PROP_"+window.orderProps.STORE_ID).val();if(e){var i,n=[];for(i in window.omni.SHOPS[e])n.push(parseInt(i))}}var e=$(".bx_ordercart_order_table_container"),r={main:0,discount:0,loyalty:0,delivery:parseInt($(".delivery-price").data("price"))},e=(e.find(".b-order__basket-item").removeClass("no_delivered").find(".no_delivered_block").remove(),e.find(".b-order__basket-item").each(function(){var e=$(this).data("id"),i=$(this).data("price"),t=$(this).data("baseprice"),o=$(this).data("loyalty"),a=$(this).data("quantity");-1<$.inArray(e,n)?(r.main+=i*a,i<t&&(r.discount+=(t-i)*a),0<o&&(r.loyalty+=o*a)):$(this).addClass("no_delivered").find(".col-xs-8").append('<div class="no_delivered_block">Не доставляется выбранным способом. Товар можно заказать отдельно.</div>')}),r.main+=r.delivery,r.discount-=r.loyalty,$("#totalDiscount")),e=(e.find(".discount-value").html("-"+priceFormat(r.discount)),e.toggleClass("hidden",r.discount<=0),$("#totalLoyalty"));e.html("-"+priceFormat(r.loyalty)),e.toggleClass("hidden",r.loyalty<=0),$("#totalPrice").html(priceFormat(r.main)),$("#fast_delivery").prop("checked")?$("#ID_PAY_SYSTEM_ID_3").prop("checked")?$('label[for="ID_PAY_SYSTEM_ID_7"]').click():($("#ID_PAY_SYSTEM_ID_3").prop("disabled",!0),$('label[for="ID_PAY_SYSTEM_ID_3"]').attr("title",'Для данного способа доставки доступна только "Онлайн оплата"')):($("#ID_PAY_SYSTEM_ID_3").prop("disabled",!1),$('label[for="ID_PAY_SYSTEM_ID_3"]').attr("title",""))}function priceFormat(e){return number_format(e,0,"."," ")+" &#8381;"}function number_format(e,i,t,o){var a,n;return isNaN(i=Math.abs(i))&&(i=2),null==t&&(t=","),null==o&&(o="."),((n=3<(n=(a=parseInt(e=(+e||0).toFixed(i))+"").length)?n%3:0)?a.substr(0,n)+o:"")+a.substr(n).replace(/(\d{3})(?=\d)/g,"$1"+o)+(i?t+Math.abs(e-a).toFixed(i).replace(/-/,0).slice(2):"")}function checkSelectedStore(){var e=window.preStoreId,i=window.preStoreId=!1,t=!1;""!=e&&($("#shopDeliveryBlock").is(":visible")&&e in window.shops&&(i="shop",t=window.shops[e]),$("#pvzDeliveryBlock").is(":visible")&&e in window.pvz&&(i="pvz",t=window.pvz[e]),i&&t?setPickupPlace(i,t,!0):window.orderProps&&window.orderProps.STORE_ID&&$("#ORDER_PROP_"+window.orderProps.STORE_ID).val(""))}function setPickupPlace(e,i,t){if(!i)return!1;t=t||!1;var o="pvz"==e?i.CODE:i.ID,a=i.ADDRESS,n="pvz"==e?"Забрать в пункте выдачи: ":"Получить в магазине: ",r=$("#deliveryPlaceSelect"),o=(void 0!==window.digitalData.events&&(window.digitalData.cart.shopName=a,window.digitalData.events.push({category:"Ecommerce",name:"Selected Pickup Point",cart:window.digitalData.cart})),$("#ORDER_PROP_"+window.orderProps.STORE_ID).val(o),$("#ORDER_PROP_"+window.orderProps.F_ADDRESS).val(a),$(".js-cart-address").html(a),$(".delivery-pvz-list-item").removeClass("active"),$(".delivery-pvz-list-item[data-"+e+'="'+o+'"]').addClass("active"),checkOmni(),$(".delivery-place-select .delivery-pay-warning").toggleClass("hidden",!("pvz"==e&&"cash"==getPaymentType()&&"Y"==i.PROPERTIES.FORBIDDEN_CASH)),n+" <b>"+a+"</b>");"PROPERTIES"in i&&(o+="<p>"+i.PROPERTIES.HOW_TO_GET+"</p>"),o+='<span style="display: inline-block; width: 100%; text-align: center;"><a href="#" class="btn btn-default btn-popup-pickup-place-ok" style="display: inline-block; width: 100px; margin-top: 10px;">Ok</a></span>',$(document).off("click",".btn-popup-pickup-place-ok").on("click",".btn-popup-pickup-place-ok",function(e){e.preventDefault(),$(this).closest(".modal").find(".close").trigger("click")}),t||orderPopup("Выбран способ доставки",o),r.text(n+a).parent().show(),$(".delivery-block.active").hide()}function initMap(h){ymaps.ready(function(){$("#"+h).html("");var e=window.pvz,i=window.shops,t=!1,o=!1,a={iconLayout:"default#image",iconImageHref:window.templatePath+"/images/3.png",iconImageSize:[40,51],iconImageOffset:[-5,-38]},n="pvzmap"==h?"pvz":"shop";if("pvz"==n){var r,d=[],l=0;for(r in e){var s=e[r];s.PROPERTIES.GEO_LAT=parseFloat(s.PROPERTIES.GEO_LAT),s.PROPERTIES.GEO_LON=parseFloat(s.PROPERTIES.GEO_LON),t=t||[s.PROPERTIES.GEO_LAT,s.PROPERTIES.GEO_LON],d[l]=getPlacemark(n,s,a),l++}var c=new ymaps.Map(h,{center:t,zoom:10,controls:[]},{searchControlProvider:"yandex#search"}),p=new ymaps.Clusterer({clusterDisableClickZoom:!1});p.add(d),c.geoObjects.add(p),c.controls.add(new ymaps.control.ZoomControl({options:{size:"small"}}))}if("shop"==n){var u,v=[],l=0;for(u in i){var m=i[u];m.GPS_N=parseFloat(m.GPS_N),m.GPS_S=parseFloat(m.GPS_S),o=o||[m.GPS_N,m.GPS_S],v[l]=getPlacemark(n,m,a),l++}p=new ymaps.Map(h,{center:o,zoom:10,controls:[]},{searchControlProvider:"yandex#search"}),c=new ymaps.Clusterer({clusterDisableClickZoom:!1});c.add(v),p.geoObjects.add(c),p.controls.add(new ymaps.control.ZoomControl({options:{size:"small"}}))}})}function getPlacemark(i,t,e){var o,a;return"pvz"==i&&(o={hintContent:t.ADDRESS},(a=new ymaps.Placemark([t.PROPERTIES.GEO_LAT,t.PROPERTIES.GEO_LON],o,e)).events.add("click",function(){var e={id:t.CODE,name:t.ADDRESS,metro:t.PROPERTIES.METRO,time:"",address:t.PROPERTIES.ADDRESS,phone:t.PROPERTIES.PHONE,how:t.PROPERTIES.HOW_TO_GET,cash:t.PROPERTIES.FORBIDDEN_CASH};setPlace(i,e)})),"shop"==i&&(o={hintContent:t.TITLE},(a=new ymaps.Placemark([t.GPS_N,t.GPS_S],o,e)).events.add("click",function(){var e={id:t.ID,name:t.TITLE,metro:"",time:t.SCHEDULE,address:t.ADDRESS,phone:t.PHONE,how:""};setPlace(i,e)})),a}function setPlace(e,i){var t=$("pvz"==e?"#pvzside":"#shopside"),o=t.find(".delivery-pvz-side-title"),a=t.find(".delivery-pvz-side-phone"),n=t.find(".delivery-pvz-side-metro"),r=t.find(".delivery-pvz-side-time-text"),d=t.find(".delivery-pvz-side-how-text"),l=t.find(".delivery-pvz-side-address"),s=t.find(".b-order-basket__main-contacts-text-form-btn");o.html(i.name),a.html(i.phone),i.metro?n.removeClass("hidden").html(i.metro):n.addClass("hidden").html(""),i.time?(r.parent().removeClass("hidden"),r.html(i.time)):(r.parent().addClass("hidden"),r.html("")),i.how||(i.how=i.address),i.how?(d.parent().removeClass("hidden"),d.html(i.how)):(d.parent().addClass("hidden"),d.html("")),i.address?l.removeClass("hidden").html(i.address):l.addClass("hidden").html(""),s.data("id",i.id),s.data("type",e),t.find(".delivery-pay-warning").toggleClass("hidden",!("cash"==getPaymentType()&&"Y"==i.cash)),t.show()}function initOnlinePayDiscountCheckbox(){$("#onlineDiscountCheckbox").on("change",function(){($(this).prop("checked")?$("#ID_PAY_SYSTEM_ID_"+window.paySystemId.online):$("#ID_PAY_SYSTEM_ID_"+window.paySystemId.cash)).trigger("click")})}function showOnlinePayDiscountInfo(){"pickup"==getDeliveryType()?($(".b-order__props-payment span.online-pay-discount-label").hide(),$(".b-order__info-total .checkout__total_discount-info").hide()):($(".b-order__props-payment span.online-pay-discount-label").show(),$(".b-order__info-total .checkout__total_discount-info").show())}function checkPlugins(){$.isFunction($.fn.validate)||(console.log("validate plugin error"),$.getScript("/local/blocks/i-validate/i-validate.min.js")),$.isFunction($.fn.mask)||(console.log("mask plugin error"),$.getScript("/local/blocks/i-mask/i-mask.min.js")),$.isFunction($.fn.validate)||(console.log("plugins error"),location.href=location.pathname)}$(function(){checkPlugins();var s=$("#ORDER_FORM"),e=$("body");$.validator.addMethod("regex",function(e,i,t){t=new RegExp(t);return this.optional(i)||t.test(e)},"Проверьте правильность заполнения"),$.validator.addMethod("requiredConfirm",function(e,i){return e=$.trim(e),!(checkConfirm()&&!e)},"Поле должно быть заполнено"),$.validator.addMethod("requiredCourier",function(e,i){if("courierStreet"==$(i).attr("name")&&"CITY"!=window.locationType)return!0;e=$.trim(e);i=getDeliveryType();return!(("courier"==i||"day"==i)&&checkConfirm()&&!e)},"Поле должно быть заполнено");s.validate({rules:{ORDER_PROP_1:{requiredConfirm:!0},ORDER_PROP_4:{requiredConfirm:!0,phoneFormat:!0},ORDER_PROP_3:{requiredConfirm:!0,email:!0,mailFormat:!0},ORDER_PROP_5:{requiredConfirm:!0},ORDER_PROP_6:{requiredConfirm:!0},"i-agree":{requiredConfirm:!0},courierStreet:{requiredCourier:!0},courierHouse:{requiredCourier:!0}},submitHandler:function(e,i){var t=checkConfirm(),o=getDeliveryType(),a=$("#ORDER_PROP_"+window.orderProps.STORE_ID).val(),n=[];if(window.preStoreType=o,window.preStoreId=a,t&&(o?("ozon"!=o||a.length||n.push("Не выбран пункт выдачи заказов"),"pickup"!=o||a.length||n.push("Не выбран магазин для самовывоза товаров")):(n.push("Не выбрана служба доставки"),$("html, body").animate({scrollTop:$(".b-order__props-delivery-title").offset().top-20},600))),n.length)orderPopup("Обратите внимание",n.join('</p><p class="center">')),$("html, body").animate({scrollTop:$(".b-order__props-delivery-title").offset().top-20},600);else if("Y"!=s.data("submit")){BX.showWait(),s.data("submit","Y");var r,d={},l=s.serializeArray();for(r in l)"DELIVERY_ID"==l[r].name&&(l[r].value=parseInt(l[r].value),l[r].value==window.deliveryId.courier&&$("#fast_delivery").prop("checked")&&(l[r].value=parseInt($("#fast_delivery").data("delivery")))),d[l[r].name]=l[r].value;$.post(s.attr("action"),d,function(e){BX.closeWait(),s.data("submit","N"),ajaxResult(e)})}return!1},invalidHandler:function(e,i){for(var t=0;t<i.errorList.length;t++){var o=i.errorList[t].element;$("html, body").animate({scrollTop:$(o).offset().top-20},600);break}BX.closeWait()}}),e.on("click","#ORDER_CONFIRM_BUTTON",function(e){e.preventDefault(),submitForm("Y")}),e.on("click",".b-order__basket-item-delete",function(){var e=$(this),i=e.attr("data-id"),t=e.data("product-id"),o=null,a=0;if(void 0!==window.digitalData.events&&void 0!==window.digitalData.cart){for(var n=0;n<window.digitalData.cart.lineItems.length;n++)if(window.digitalData.cart.lineItems[n].product.skuCode==t){o=window.digitalData.cart.lineItems[n].product,a=window.digitalData.cart.lineItems[n].quantity;break}window.digitalData.events.push({category:"Ecommerce",name:"Removed Product",product:{id:o.id,skuCode:o.skuCode},quantity:a}),$.post("/local/ajax/remove_from_basket.php",{sessid:$("#sessid").val(),id:i}).done(function(){submitForm()})}}),e.on("click",".btn-set-coupon",function(e){e.preventDefault();e=$(".b-order__promo-code-input").val();e&&$.post("/local/ajax/set_coupon.php",{sessid:$("#sessid").val(),coupon:e}).done(function(e){submitForm()})}),e.on("click",".b-order-basket__side-promo-coupon-remove",function(){$.post("/local/ajax/remove_coupon.php",{sessid:$("#sessid").val(),coupon:$(this).data("coupon")}).done(function(e){submitForm()})}),e.on("click","#accept_loyalty",function(e){e.preventDefault();var i=$(".b-order__bonus-card").validate(),t=$(this),e=$("input[name=LOYALTY_CARD]").val();e?79==Math.floor(e/1e6)?(t.addClass("btn_load"),$.post("/local/ajax/set_bonus.php",{number:e,sessid:$("#sessid").val()}).done(function(e){e=JSON.parse(e);0<e.BALANCE?($("input[name=LOYALTY_VALID]").val("Y"),$(".b-order__bonus-card-balance").html(e.BALANCE_FORMATTED),$(".b-order__bonus-card-calculation").html(e.ADD_TO_CARD_FORMATTED),-1!=e.WRITE_OFF_FORMATTED&&$(".b-order__bonus-card-writeoff").html(.2*e)):(errors={LOYALTY_CARD:"Данная карта не относится к бонусной программе Juicy Couture"},i.showErrors(errors)),$(".b-order__bonus-card-info").removeClass("hidden"),t.removeClass("btn_load")})):(errors={LOYALTY_CARD:"Данная карта не относится к бонусной программе Juicy Couture"},i.showErrors(errors)):(errors={LOYALTY_CARD:"Введите номер бонусной карты"},i.showErrors(errors))}),e.on("click",".b-order__props-delivery label.btn",function(){var e,i;void 0!==window.digitalData.events&&(e=$(this).find("div").text(),i=$(this).find("div").attr("data-delivery"),window.digitalData.cart.shippingMethod=$.trim(e),window.digitalData.cart.shippingCost=i,window.digitalData.events.push({name:"Selected Shipping Method",cart:window.digitalData.cart})),setTimeout(function(){submitForm()},10)}),e.on("click",".b-order__props-payment label",function(){var e;void 0!==window.digitalData.events&&(e=$(this).find("div").text(),window.digitalData.cart.paymentMethod=$.trim(e),window.digitalData.events.push({name:"Selected Payment Method",cart:window.digitalData.cart})),setTimeout(function(){submitForm()},10)}),e.on("click",".mobile-hidden-form .hidden-block-title",function(){$(this).closest(".mobile-hidden-form").toggleClass("show-form")}),$("#closeQuickViewProduct").on("click",function(e){$("#quickViewProduct").modal("hide")}),initOrderActions(),$("#payOnlineHelp").tooltip({html:!0,title:$("#payOnlineHelpText").html(),placement:"right",template:'<div class="tooltip tooltip-online" role="tooltip"><div class="arrow"></div><div class="tooltip-inner"></div></div>',trigger:"click"}),$("#js-popup-error").on("hidden.bs.modal",function(e){submitForm()}),BX.closeWait()});